<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  A small entity component system · Amber Thrall
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Amber Thrall">
<meta name="description" content="Imagine creating a game using an object oriented (OO) design. You may have a base class representing entities (&ldquo;objects&rdquo; placed throughout the world). Derived from entities you have several sub-classes representing various different behaviors.

As your game gets more and more complex, the more of a mess your class structure becomes. For example, consider the class structure drawn out above. If your team decided to create an important friendly NPC that was unkillable, major refactoring would be required. In otherwords, as time goes on, the harder adding new features to your game becomes.">
<meta name="keywords" content="">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="A small entity component system">
  <meta name="twitter:description" content="Imagine creating a game using an object oriented (OO) design. You may have a base class representing entities (“objects” placed throughout the world). Derived from entities you have several sub-classes representing various different behaviors.
As your game gets more and more complex, the more of a mess your class structure becomes. For example, consider the class structure drawn out above. If your team decided to create an important friendly NPC that was unkillable, major refactoring would be required. In otherwords, as time goes on, the harder adding new features to your game becomes.">

<meta property="og:url" content="http://localhost:1313/posts/ecs/">
  <meta property="og:site_name" content="Amber Thrall">
  <meta property="og:title" content="A small entity component system">
  <meta property="og:description" content="Imagine creating a game using an object oriented (OO) design. You may have a base class representing entities (“objects” placed throughout the world). Derived from entities you have several sub-classes representing various different behaviors.
As your game gets more and more complex, the more of a mess your class structure becomes. For example, consider the class structure drawn out above. If your team decided to create an important friendly NPC that was unkillable, major refactoring would be required. In otherwords, as time goes on, the harder adding new features to your game becomes.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-05-21T11:37:09-07:00">
    <meta property="article:modified_time" content="2022-05-21T11:37:09-07:00">




<link rel="canonical" href="http://localhost:1313/posts/ecs/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.css" media="screen">
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      Amber Thrall
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/research/">Research</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/projects/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/contact/">Contact Me</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/ecs/">
              A small entity component system
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2022-05-21T11:37:09-07:00">
                May 21, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              5-minute read
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div class="post-content">
        
        <p>Imagine creating a game using an object oriented (OO) design. You may have a base class representing entities (&ldquo;objects&rdquo; placed throughout the world). Derived from entities you have several sub-classes representing various different behaviors.</p>
<p><img src="/images/ecs_oo.png" alt="Sample OO Design"></p>
<p>As your game gets more and more complex, the more of a mess your class structure becomes. For example, consider the class structure drawn out above. If your team decided to create an important friendly NPC that was unkillable, major refactoring would be required. In otherwords, as time goes on, the harder adding new features to your game becomes.</p>
<p>Enter entity component systems (ECS). Instead of an OO architecture, we use a more data-driven approach. ECSs are composed of three parts:</p>
<ol>
<li>Entities: very simple, globally unique identifiers.</li>
<li>Components: provide data structures to entities.</li>
<li>Systems: provides behavior between components.</li>
</ol>
<p>For example, consider the player and dragon entities described below:</p>
<p><img src="/images/ecs.png" alt="Sample ECS Design"></p>
<p>Both have a <code>Position</code> and <code>Health</code> component, but have unique behavior that require special components. With this new design, adding new features to your game is as simple as creating the necessary components/systems and attaching them to the correct entities.</p>
<p>One may notice, that ECS has similarities to a relational database such as SQL. Entities represent keys, components represent tables, and systems represent queries.</p>
<p>If you want more information on ECS, I recommend Catherine West&rsquo;s <a href="https://www.youtube.com/watch?v=aKLntZcp27M"  class="external-link" target="_blank" rel="noopener">RustConf 2018 Keynote</a> available on YouTube or their corresponding <a href="https://kyren.github.io/2018/09/14/rustconf-talk.html"  class="external-link" target="_blank" rel="noopener">blog post</a>.</p>
<h2 id="first-attempt">
  First Attempt
  <a class="heading-link" href="#first-attempt">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>For a first crude attempt, we simple add a field for each possible component. Each component is stored in a <code>HashMap</code> allowing components to be attached specifically to certain entities. We also use a central &ldquo;database&rdquo; <code>struct ECS</code> to store and access each component.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">struct</span> <span style="color:#f0883e;font-weight:bold">Position</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>x: <span style="color:#ff7b72">f64</span>,<span style="color:#6e7681"> </span>y: <span style="color:#ff7b72">f64</span>
</span></span><span style="display:flex;"><span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">struct</span> <span style="color:#f0883e;font-weight:bold">Health</span>(<span style="color:#ff7b72">f64</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">type</span> <span style="color:#f0883e;font-weight:bold">Entity</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">usize</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">struct</span> <span style="color:#f0883e;font-weight:bold">ECS</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>entities: Vec<span style="color:#ff7b72;font-weight:bold">&lt;</span>Option<span style="color:#ff7b72;font-weight:bold">&lt;</span>Entity<span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>position_components: <span style="color:#f0883e;font-weight:bold">HashMap</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>Entity,<span style="color:#6e7681"> </span>Position<span style="color:#ff7b72;font-weight:bold">&gt;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>health_components: <span style="color:#f0883e;font-weight:bold">HashMap</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>Entity,<span style="color:#6e7681"> </span>Health<span style="color:#ff7b72;font-weight:bold">&gt;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>In this example, I store a registry of entities with <code>Vec&lt;Option&lt;Entity&gt;&gt;</code>, where <code>Entity</code> is an alias for <code>usize</code>. When registering a new entity into the database, we simply look for the first <code>None</code> in the registry and replace it with the entity&rsquo;s id. If the registry is full, we expand the vector.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">impl</span><span style="color:#6e7681"> </span><span style="color:#79c0ff;font-weight:bold">ECS</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// More...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">register_entity</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self)<span style="color:#6e7681"> </span>-&gt; <span style="color:#f0883e;font-weight:bold">Entity</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>self.entities.iter().position(<span style="color:#ff7b72;font-weight:bold">|</span>entity<span style="color:#ff7b72;font-weight:bold">|</span><span style="color:#6e7681"> </span>entity.is_none())<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Some(id)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>self.entities[id]<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>Some(id);<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>id<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>None<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>id<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>self.entities.len();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>self.entities.push(Some(id));<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>id<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">unregister_entity</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self,<span style="color:#6e7681"> </span>id: <span style="color:#f0883e;font-weight:bold">Entity</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>id<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;</span><span style="color:#6e7681"> </span>self.entities.len()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>self.entities[id]<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>None;<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>self.position_components.remove(<span style="color:#ff7b72;font-weight:bold">&amp;</span>id);<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>self.health_components.remove(<span style="color:#ff7b72;font-weight:bold">&amp;</span>id);<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">attach_position_component</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self,<span style="color:#6e7681"> </span>id: <span style="color:#f0883e;font-weight:bold">Entity</span>,<span style="color:#6e7681"> </span>position: <span style="color:#f0883e;font-weight:bold">Position</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// impl...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">attach_health_component</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self,<span style="color:#6e7681"> </span>id: <span style="color:#f0883e;font-weight:bold">Entity</span>,<span style="color:#6e7681"> </span>health: <span style="color:#f0883e;font-weight:bold">Health</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// impl...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>This allows up to $2^{64}$ possible entities to be registered at once. If for some reason you need more than that, I recommend using the <a href="https://crates.io/crates/uuid"  class="external-link" target="_blank" rel="noopener">uuid crate</a>. While this setup works just fine, things can get quite messy as you add more and more components to your game.</p>
<h2 id="generalized-attempt">
  Generalized Attempt
  <a class="heading-link" href="#generalized-attempt">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Instead of having a field for each possible component type, we want one field for all possible components. In rust we can achieve this with the
<code>Any</code> trait. More specifically, by combining the <code>Any</code> trait with <code>TypeId</code>, we can create a <code>HashMap</code> that can store one of each possible type.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">struct</span> <span style="color:#f0883e;font-weight:bold">AnyMap</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>map: <span style="color:#f0883e;font-weight:bold">HashMap</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>TypeId,<span style="color:#6e7681"> </span>Box<span style="color:#ff7b72;font-weight:bold">&lt;</span><span style="color:#ff7b72">dyn</span><span style="color:#6e7681"> </span>Any<span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>Some crates already exist for this (namely <a href="https://crates.io/crates/anymap"  class="external-link" target="_blank" rel="noopener">anymap</a>), which should probably be used. To avoid dependencies, I&rsquo;ve implemented a simple <code>AnyMap</code> myself.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">impl</span><span style="color:#6e7681"> </span>AnyMap<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// More...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">insert</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>T: &#39;static<span style="color:#ff7b72;font-weight:bold">&gt;</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self,<span style="color:#6e7681"> </span>value: <span style="color:#f0883e;font-weight:bold">T</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>self.map.insert(TypeId::of::<span style="color:#ff7b72;font-weight:bold">&lt;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span>(),<span style="color:#6e7681"> </span>Box::new(value));<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">remove</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>T: &#39;static<span style="color:#ff7b72;font-weight:bold">&gt;</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>self.map.remove(<span style="color:#ff7b72;font-weight:bold">&amp;</span>TypeId::of::<span style="color:#ff7b72;font-weight:bold">&lt;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span>());<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">get</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>T: &#39;static<span style="color:#ff7b72;font-weight:bold">&gt;</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>self)<span style="color:#6e7681"> </span>-&gt; Option<span style="color:#ff7b72;font-weight:bold">&lt;&amp;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>self.map.get(<span style="color:#ff7b72;font-weight:bold">&amp;</span>TypeId::of::<span style="color:#ff7b72;font-weight:bold">&lt;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span>()).map(<span style="color:#ff7b72;font-weight:bold">|</span>x<span style="color:#ff7b72;font-weight:bold">|</span><span style="color:#6e7681"> </span>x.downcast_ref::<span style="color:#ff7b72;font-weight:bold">&lt;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span>().unwrap())<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">get_mut</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>T: &#39;static<span style="color:#ff7b72;font-weight:bold">&gt;</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self)<span style="color:#6e7681"> </span>-&gt; Option<span style="color:#ff7b72;font-weight:bold">&lt;&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>self.map.get_mut(<span style="color:#ff7b72;font-weight:bold">&amp;</span>TypeId::of::<span style="color:#ff7b72;font-weight:bold">&lt;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span>()).map(<span style="color:#ff7b72;font-weight:bold">|</span>x<span style="color:#ff7b72;font-weight:bold">|</span><span style="color:#6e7681"> </span>x.downcast_mut::<span style="color:#ff7b72;font-weight:bold">&lt;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span>().unwrap())<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>This struct allows us to store any type, for example <code>u32</code>, with <code>map.insert(0u32)</code> and retrieve it with either <code>map.get::&lt;u32&gt;()</code> or <code>map.get_mut::&lt;u32&gt;()</code>. With <code>AnyMap</code>, we can replace the multiple component fields with a single field.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">struct</span> <span style="color:#f0883e;font-weight:bold">ECS</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>entities: Vec<span style="color:#ff7b72;font-weight:bold">&lt;</span>Option<span style="color:#ff7b72;font-weight:bold">&lt;</span>Entity<span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>components: <span style="color:#f0883e;font-weight:bold">HashMap</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>Entity,<span style="color:#6e7681"> </span>AnyMap<span style="color:#ff7b72;font-weight:bold">&gt;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>Then attaching, detaching and borrowing entity&rsquo;s components is as simple as looking up the entity, followed by calling the corresponding method from <code>AnyMap</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">impl</span><span style="color:#6e7681"> </span><span style="color:#79c0ff;font-weight:bold">ECS</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// More...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">attach_component</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>T: &#39;static<span style="color:#ff7b72;font-weight:bold">&gt;</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self,<span style="color:#6e7681"> </span>entity: <span style="color:#f0883e;font-weight:bold">Entity</span>,<span style="color:#6e7681"> </span>component: <span style="color:#f0883e;font-weight:bold">T</span>)<span style="color:#6e7681"> </span>-&gt; Result<span style="color:#ff7b72;font-weight:bold">&lt;</span>(),<span style="color:#6e7681"> </span>String<span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>self.entities.iter().position(<span style="color:#ff7b72;font-weight:bold">|</span>x<span style="color:#ff7b72;font-weight:bold">|</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">*</span>x<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">==</span><span style="color:#6e7681"> </span>Some(entity))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Some(id)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>self.components.get_mut(<span style="color:#ff7b72;font-weight:bold">&amp;</span>id).unwrap().insert(component);<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>Ok(())<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>None<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Err(format!(<span style="color:#a5d6ff">&#34;No entity with id </span><span style="color:#a5d6ff">{}</span><span style="color:#a5d6ff"> found.&#34;</span>,<span style="color:#6e7681"> </span>entity)),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">detach_component</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>T: &#39;static<span style="color:#ff7b72;font-weight:bold">&gt;</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self,<span style="color:#6e7681"> </span>entity: <span style="color:#f0883e;font-weight:bold">Entity</span>)<span style="color:#6e7681"> </span>-&gt; Result<span style="color:#ff7b72;font-weight:bold">&lt;</span>(),<span style="color:#6e7681"> </span>String<span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>self.entities.iter().position(<span style="color:#ff7b72;font-weight:bold">|</span>x<span style="color:#ff7b72;font-weight:bold">|</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">*</span>x<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">==</span><span style="color:#6e7681"> </span>Some(entity))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Some(id)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>self.components.get_mut(<span style="color:#ff7b72;font-weight:bold">&amp;</span>id).unwrap().remove::<span style="color:#ff7b72;font-weight:bold">&lt;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span>();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>Ok(())<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>None<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Err(format!(<span style="color:#a5d6ff">&#34;No entity with id </span><span style="color:#a5d6ff">{}</span><span style="color:#a5d6ff"> found.&#34;</span>,<span style="color:#6e7681"> </span>entity)),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">get_component</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>T: &#39;static<span style="color:#ff7b72;font-weight:bold">&gt;</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>self,<span style="color:#6e7681"> </span>entity: <span style="color:#f0883e;font-weight:bold">Entity</span>)<span style="color:#6e7681"> </span>-&gt; Option<span style="color:#ff7b72;font-weight:bold">&lt;&amp;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>Some(map)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>self.components.get(<span style="color:#ff7b72;font-weight:bold">&amp;</span>entity)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>map.get::<span style="color:#ff7b72;font-weight:bold">&lt;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span>()<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>None<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">get_component_mut</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>T: &#39;static<span style="color:#ff7b72;font-weight:bold">&gt;</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self,<span style="color:#6e7681"> </span>entity: <span style="color:#f0883e;font-weight:bold">Entity</span>)<span style="color:#6e7681"> </span>-&gt; Option<span style="color:#ff7b72;font-weight:bold">&lt;&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>Some(map)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>self.components.get_mut(<span style="color:#ff7b72;font-weight:bold">&amp;</span>entity)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>map.get_mut::<span style="color:#ff7b72;font-weight:bold">&lt;</span>T<span style="color:#ff7b72;font-weight:bold">&gt;</span>()<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>None<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>With this, we now have a simple entity component system implemented in rust.</p>
<h2 id="what-about-systems">
  What About Systems?
  <a class="heading-link" href="#what-about-systems">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>You may have noticed I didn&rsquo;t talk much about systems. Implementing the various systems into your game is going to depend heavily on the task. In this example, I assume all systems are implemented as component methods. For example, for a render system you might create a sprite component with a render method that is called during the game loop.</p>
<p>Alternatively, you may decide to implement an event based system. For example, a physics system might only be ran whenever two entities collide.</p>
<p>I leave that up to you!</p>
<p>The full code can be seen on GitHub at: <a href="https://gist.github.com/AmberThrall/308e2d683dbd67bc91b681d4fa69d32c"  class="external-link" target="_blank" rel="noopener">https://gist.github.com/AmberThrall/308e2d683dbd67bc91b681d4fa69d32c</a></p>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2025
     Amber Thrall 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
