<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  Interpreting a C-like language in Rust · Amber Thrall
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Amber Thrall">
<meta name="description" content="Lately I&rsquo;ve been learning the programming language rust. To challenge myself, I decided to create an interpreter for a small
C-like language called &ldquo;Tiny-C&rdquo;. I&rsquo;m still quite new to rust, but I am happy with the end result. You can view the code on GitHub at: https://github.com/AmberThrall/TinyC

  Defining the language
  
    
    Link to heading
  

Before creating an interpreter for a language, we need to define how our language works and create a parser. I based the language
on Marc Feeley&rsquo;s &ldquo;Tiny-C Compiler&rdquo; I came across on GitHub. It supports if statements, if-else statements, while statements and do statements. While Feeley&rsquo;s compiler only supports four binary operators (&#43;, -, &lt; and =), I decided to include 12 binary operators (&#43;, -, *, /, &lt;, &gt;, &lt;=, &gt;=, ==, =, &amp;&amp; and ||). I&rsquo;ve also included a single function print built-in to the language which simply prints out the provided value to stdout.">
<meta name="keywords" content="">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Interpreting a C-like language in Rust">
  <meta name="twitter:description" content="Lately I’ve been learning the programming language rust. To challenge myself, I decided to create an interpreter for a small C-like language called “Tiny-C”. I’m still quite new to rust, but I am happy with the end result. You can view the code on GitHub at: https://github.com/AmberThrall/TinyC
Defining the language Link to heading Before creating an interpreter for a language, we need to define how our language works and create a parser. I based the language on Marc Feeley’s “Tiny-C Compiler” I came across on GitHub. It supports if statements, if-else statements, while statements and do statements. While Feeley’s compiler only supports four binary operators (&#43;, -, &lt; and =), I decided to include 12 binary operators (&#43;, -, *, /, &lt;, &gt;, &lt;=, &gt;=, ==, =, &amp;&amp; and ||). I’ve also included a single function print built-in to the language which simply prints out the provided value to stdout.">

<meta property="og:url" content="http://localhost:1313/posts/tinyc_rust/">
  <meta property="og:site_name" content="Amber Thrall">
  <meta property="og:title" content="Interpreting a C-like language in Rust">
  <meta property="og:description" content="Lately I’ve been learning the programming language rust. To challenge myself, I decided to create an interpreter for a small C-like language called “Tiny-C”. I’m still quite new to rust, but I am happy with the end result. You can view the code on GitHub at: https://github.com/AmberThrall/TinyC
Defining the language Link to heading Before creating an interpreter for a language, we need to define how our language works and create a parser. I based the language on Marc Feeley’s “Tiny-C Compiler” I came across on GitHub. It supports if statements, if-else statements, while statements and do statements. While Feeley’s compiler only supports four binary operators (&#43;, -, &lt; and =), I decided to include 12 binary operators (&#43;, -, *, /, &lt;, &gt;, &lt;=, &gt;=, ==, =, &amp;&amp; and ||). I’ve also included a single function print built-in to the language which simply prints out the provided value to stdout.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-03-31T11:37:09-07:00">
    <meta property="article:modified_time" content="2022-03-31T11:37:09-07:00">




<link rel="canonical" href="http://localhost:1313/posts/tinyc_rust/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.css" media="screen">
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      Amber Thrall
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/research/">Research</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/projects/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/contact/">Contact Me</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/tinyc_rust/">
              Interpreting a C-like language in Rust
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2022-03-31T11:37:09-07:00">
                March 31, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              9-minute read
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div class="post-content">
        
        <p>Lately I&rsquo;ve been learning the programming language rust. To challenge myself, I decided to create an interpreter for a small
C-like language called &ldquo;Tiny-C&rdquo;. I&rsquo;m still quite new to rust, but I am happy with the end result. You can view the code on GitHub at: <a href="https://github.com/AmberThrall/TinyC"  class="external-link" target="_blank" rel="noopener">https://github.com/AmberThrall/TinyC</a></p>
<h2 id="defining-the-language">
  Defining the language
  <a class="heading-link" href="#defining-the-language">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Before creating an interpreter for a language, we need to define how our language works and create a parser. I based the language
on <a href="https://gist.github.com/KartikTalwar/3095780"  class="external-link" target="_blank" rel="noopener">Marc Feeley&rsquo;s &ldquo;Tiny-C Compiler&rdquo;</a> I came across on GitHub. It supports if statements, if-else statements, while statements and do statements. While Feeley&rsquo;s compiler only supports four binary operators (+, -, &lt; and =), I decided to include 12 binary operators (+, -, *, /, &lt;, &gt;, &lt;=, &gt;=, ==, =, &amp;&amp; and ||). I&rsquo;ve also included a single function <code>print</code> built-in to the language which simply prints out the provided value to stdout.</p>
<p>All variables represent 64-bit signed integers. There is no boolean type, so I made conditions evaluate &ldquo;true&rdquo; if they are greater than 0 and the various comparison operators return either 0 or 1.</p>
<p>For parsing, I decided to make use of the library <a href="https://pest.rs/"  class="external-link" target="_blank" rel="noopener">pest</a> instead of creating my own parser from scratch. The grammar for the language is as follows:</p>
<pre tabindex="0"><code>program = { SOI ~ statement? ~ EOI }
statement = {
  if_else_statement
  | if_statement
  | while_statement
  | do_statement
  | block_statement
  | expr_statement
  | print_statement
  | semicolon
}
if_statement = { &#34;if&#34; ~ paren_expr ~ statement }
if_else_statement = { &#34;if&#34; ~ paren_expr ~ statement ~ &#34;else&#34; ~ statement }
while_statement = { &#34;while&#34; ~ paren_expr ~ statement }
do_statement = { &#34;do&#34; ~ statement ~ &#34;while&#34; ~ paren_expr ~ semicolon }
block_statement = { &#34;{&#34; ~ statement* ~ &#34;}&#34; }
expr_statement = { expr ~ semicolon }
print_statement = { &#34;print&#34; ~ paren_expr ~ semicolon }
semicolon = { &#34;;&#34; }

paren_expr = { &#34;(&#34; ~ expr ~ &#34;)&#34; }
expr = { term ~ (op ~ term)* }
term = { id | int | paren_expr }
op = { &#34;+&#34; | &#34;-&#34; | &#34;*&#34; | &#34;/&#34; | &#34;&lt;&#34; | &#34;&gt;&#34; | &#34;&lt;=&#34; | &#34;&gt;=&#34; | &#34;==&#34; | &#34;=&#34; | &#34;&amp;&amp;&#34; | &#34;||&#34; }
id = @{ (ASCII_ALPHA | &#34;_&#34;) ~ (ASCII_DIGIT | ASCII_ALPHA | &#34;_&#34;)* }
int = @{ &#34;-&#34;? ~ ASCII_DIGIT+ }
WHITESPACE = _{ &#34; &#34; | &#34;\t&#34; | &#34;\r&#34; | &#34;\n&#34; }
COMMENT = _{ &#34;/*&#34; ~ (!&#34;*/&#34; ~ ANY)* ~ &#34;*/&#34; }
</code></pre><p>As an example program possible in Tiny-C, consider the following program which computes the $N$-th fibonacci number then prints it:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">/* fib.tinyc
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"> * Calculate the Nth fibonacci number and print it out.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  N <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">10</span>; <span style="color:#8b949e;font-style:italic">/* The fibonacci number to calculate. */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">if</span> (N <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#d2a8ff;font-weight:bold">print</span>(<span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>    a <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>    b <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>    n <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">while</span> (n <span style="color:#ff7b72;font-weight:bold">&lt;</span> N) {
</span></span><span style="display:flex;"><span>      tmp <span style="color:#ff7b72;font-weight:bold">=</span> b;
</span></span><span style="display:flex;"><span>      b <span style="color:#ff7b72;font-weight:bold">=</span> a <span style="color:#ff7b72;font-weight:bold">+</span> b;
</span></span><span style="display:flex;"><span>      a <span style="color:#ff7b72;font-weight:bold">=</span> tmp;
</span></span><span style="display:flex;"><span>      n <span style="color:#ff7b72;font-weight:bold">=</span> n <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#d2a8ff;font-weight:bold">print</span>(b);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="creating-the-abstract-syntax-tree">
  Creating the abstract syntax tree
  <a class="heading-link" href="#creating-the-abstract-syntax-tree">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Pest&rsquo;s parser returns a tree composed of <code>Pairs</code> following the derivation. These pairs allow us to step into each rule within a derivation and view the corresponding strings for each subrule. While we could evaluate the code with just this tree alone, it&rsquo;d be better to clean it up into a easier to use format. I decided to create an enum <code>Node</code> representing each possible rule and their corresponding children.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">enum</span> <span style="color:#f0883e;font-weight:bold">Node</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>Program<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>statement: Option<span style="color:#ff7b72;font-weight:bold">&lt;</span>Box<span style="color:#ff7b72;font-weight:bold">&lt;</span>Node<span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>IfStatement<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>paren_expr: Box<span style="color:#ff7b72;font-weight:bold">&lt;</span>Node<span style="color:#ff7b72;font-weight:bold">&gt;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>statement: Box<span style="color:#ff7b72;font-weight:bold">&lt;</span>Node<span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>Int(<span style="color:#ff7b72">i64</span>),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// More nodes...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>To create a new tree, we simply take our set of pairs pest gives us into a recursive function converting each rule into the proper node.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">build_ast</span>(pair: <span style="color:#f0883e;font-weight:bold">Pair</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>Rule<span style="color:#ff7b72;font-weight:bold">&gt;</span>)<span style="color:#6e7681"> </span>-&gt; <span style="color:#f0883e;font-weight:bold">Node</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>pair.as_rule()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>Rule::program<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>record<span style="color:#6e7681"> </span><span style="color:#ff7b72">in</span><span style="color:#6e7681"> </span>pair.into_inner()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>record.as_rule()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                    </span>Rule::statement<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>Node::Program<span style="color:#6e7681"> </span>{<span style="color:#6e7681"> </span>statement: Some(Box::new(build_ast(record)))<span style="color:#6e7681"> </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                    </span>_<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>()<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Node::Program<span style="color:#6e7681"> </span>{<span style="color:#6e7681"> </span>statement: None }<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>Rule::if_statement<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>pairs<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>pair.into_inner();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Node::IfStatement<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>paren_expr: Box::new(build_ast(pairs.next().unwrap())),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>statement: Box::new(build_ast(pairs.next().unwrap()))<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>Rule::int<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Node::Int(pair.as_str().parse().unwrap()),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// More rules...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">        </span>_<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>panic!(<span style="color:#a5d6ff">&#34;Unknown rule: </span><span style="color:#a5d6ff">{:?}</span><span style="color:#a5d6ff">&#34;</span>,<span style="color:#6e7681"> </span>pair.as_rule())<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><h3 id="handling-expressions-precedence-climbing">
  Handling expressions: precedence climbing
  <a class="heading-link" href="#handling-expressions-precedence-climbing">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>If you look at the three primary grammar rules corresponding to expressions</p>
<pre tabindex="0"><code>expr = { term ~ (op ~ term)* }
term = { id | int | paren_expr }
op = { &#34;+&#34; | &#34;-&#34; | &#34;*&#34; | &#34;/&#34; | &#34;&lt;&#34; | &#34;&gt;&#34; | &#34;&lt;=&#34; | &#34;&gt;=&#34; | &#34;==&#34; | &#34;=&#34; | &#34;&amp;&amp;&#34; | &#34;||&#34; }
</code></pre><p>you may notice that expressions are composed of one long sequence alternating between terms and operators. Thus the tree for the expression 1 + 2 * 3 is:</p>
<p><img src="/images/bad_expr_ast.png" alt="Bad expression AST"></p>
<p>If we simply evaluate each child from left to right, our interpreter will claim that 1 + 2 * 3 = 9 instead of 7. We need to implement the order of operations creating a tree more like the following:</p>
<p><img src="/images/good_expr_ast.png" alt="Good expression AST"></p>
<p>With this new tree, by evaluating from bottom to top we get the correct answer of 7. To create this tree, we make use of an algorithm called <strong>precedence climbing</strong>. You can read more about precedence climbing on <a href="https://en.wikipedia.org/wiki/Operator-precedence_parser"  class="external-link" target="_blank" rel="noopener">Wikipedia</a>. We first create an enum to represent operators:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">enum</span> <span style="color:#f0883e;font-weight:bold">Operator</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>Plus,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>Minus,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// More operators...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>Then for each operator, we assign a precedence where the higher the precedence the farther down the tree the operator climbs.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">impl</span><span style="color:#6e7681"> </span>Operator<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">precedence</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>self)<span style="color:#6e7681"> </span>-&gt; <span style="color:#ff7b72">u8</span> {<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>self<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::Plus<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">3</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::Minus<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">3</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::Times<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">4</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::Divide<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">4</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::LessThen<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::GreaterThen<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::LessThenOrEqual<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::GreaterThenOrEqual<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::Equals<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::NotEquals<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::And<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">1</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::Or<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">1</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Operator::Assign<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>We&rsquo;ll break up expressions into nodes called <code>BinaryOp</code> which has three parts: an operator, the left-hand side and the right-hand side.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">enum</span> <span style="color:#f0883e;font-weight:bold">Node</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// More nodes...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">    </span>BinaryOp<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>op: <span style="color:#f0883e;font-weight:bold">Operator</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>lhs: Box<span style="color:#ff7b72;font-weight:bold">&lt;</span>Node<span style="color:#ff7b72;font-weight:bold">&gt;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>rhs: Box<span style="color:#ff7b72;font-weight:bold">&lt;</span>Node<span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>Now we can implement the actual algorithm.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">build_expr_ast</span>(<span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>pairs: <span style="color:#f0883e;font-weight:bold">Pairs</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>Rule<span style="color:#ff7b72;font-weight:bold">&gt;</span>)<span style="color:#6e7681"> </span>-&gt; <span style="color:#f0883e;font-weight:bold">Node</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>lhs<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>build_ast(pairs.next().unwrap());<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>peekable<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>pairs.peekable();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>build_expr_ast_climber(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>peekable,<span style="color:#6e7681"> </span>lhs,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">build_expr_ast_climber</span>(pairs: <span style="color:#79c0ff">&amp;</span><span style="color:#f0883e;font-weight:bold">mut</span><span style="color:#6e7681"> </span>core::iter::Peekable<span style="color:#ff7b72;font-weight:bold">&lt;</span>Pairs<span style="color:#ff7b72;font-weight:bold">&lt;</span>Rule<span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span>,<span style="color:#6e7681"> </span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>lhs: <span style="color:#f0883e;font-weight:bold">Node</span>,<span style="color:#6e7681"> </span>min_precedence: <span style="color:#ff7b72">u8</span>)<span style="color:#6e7681"> </span>-&gt; <span style="color:#f0883e;font-weight:bold">Node</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>peek<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>pairs.peek();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">while</span><span style="color:#6e7681"> </span>peek<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span>None<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>operator<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>Operator::from(peek.unwrap().as_str()).unwrap();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>operator.precedence()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;</span><span style="color:#6e7681"> </span>min_precedence<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">break</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>pairs.next();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>lookahead<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>pairs.next();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>rhs<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>build_ast(lookahead.clone().unwrap());<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>peek<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>pairs.peek();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">while</span><span style="color:#6e7681"> </span>peek<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span>None<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>next_operator<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>Operator::from(peek.unwrap().as_str()).unwrap();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>next_operator.precedence()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;=</span><span style="color:#6e7681"> </span>operator.precedence()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">break</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>rhs<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>build_expr_ast_climber(pairs,<span style="color:#6e7681"> </span>rhs,<span style="color:#6e7681"> </span>operator.precedence()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">+</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">1</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>peek<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>pairs.peek();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>lhs<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>Node::BinaryOp<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>op: <span style="color:#f0883e;font-weight:bold">operator</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>lhs: Box::new(lhs),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>rhs: Box::new(rhs)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>};<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>lhs<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>The codes a bit messy, but it works! Now we just plug our new function <code>build_expr_ast</code> into <code>build_ast</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">build_ast</span>(pair: <span style="color:#f0883e;font-weight:bold">Pair</span><span style="color:#ff7b72;font-weight:bold">&lt;</span>Rule<span style="color:#ff7b72;font-weight:bold">&gt;</span>)<span style="color:#6e7681"> </span>-&gt; <span style="color:#f0883e;font-weight:bold">Node</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>pair.as_rule()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// More rules...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">        </span>Rule::paren_expr<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>build_ast(pair.into_inner().next().unwrap()),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>Rule::expr<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>build_expr_ast(pair.into_inner()),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>_<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>panic!(<span style="color:#a5d6ff">&#34;Unknown rule: </span><span style="color:#a5d6ff">{:?}</span><span style="color:#a5d6ff">&#34;</span>,<span style="color:#6e7681"> </span>pair.as_rule())<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>We now have a easily readable abstract syntax tree. In the final code, I have a function <code>parse</code> which parses the input string using pest, then calls <code>build_ast</code> returning the root node of the AST. I&rsquo;ve also included the function <code>Node::graphviz(&amp;self, graphname: &amp;str)</code> to generate code of the tree to render with graphviz.</p>
<p>It is worth noting that precedence climbing can be built-in to the grammar itself, avoiding the work of having the parser perform this algorithm. But doing things that route makes adding more operators in the future harder. To see how easy it is to add new binary operators, check out the <a href="https://github.com/AmberThrall/TinyC/commit/b0007ce2d1035e039a6011f8eba21b262b71d237"  class="external-link" target="_blank" rel="noopener">commit</a> where I added &amp;&amp; and ||.</p>
<h2 id="evaluating-the-tree">
  Evaluating the tree
  <a class="heading-link" href="#evaluating-the-tree">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>With our easy to read abstract syntax tree built, we can now traverse down the tree evaluating nodes as we go along. I quickly created a <code>Evaluator</code> which stores our data and implements a basic stack.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">struct</span> <span style="color:#f0883e;font-weight:bold">Evaluator</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>stack: Vec<span style="color:#ff7b72;font-weight:bold">&lt;</span>HashMap<span style="color:#ff7b72;font-weight:bold">&lt;</span>String,<span style="color:#6e7681"> </span><span style="color:#ff7b72">i64</span><span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">impl</span><span style="color:#6e7681"> </span>Evaluator<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">push_scope</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>self.stack.push(HashMap::new());<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">pop_scope</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>self.stack.pop();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">write_stack</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self,<span style="color:#6e7681"> </span>ident: String,<span style="color:#6e7681"> </span>value: <span style="color:#ff7b72">i64</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>self.stack.len()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">==</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>self.push_scope();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// Search the stack backwards.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">        </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>scope<span style="color:#6e7681"> </span><span style="color:#ff7b72">in</span><span style="color:#6e7681"> </span>self.stack.iter_mut().rev()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>Some(x)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>scope.get(<span style="color:#ff7b72;font-weight:bold">&amp;</span>ident)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>scope.insert(ident,<span style="color:#6e7681"> </span>value);<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// Not already in the stack, add to top scope.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">        </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>scope<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>self.stack.last_mut().unwrap();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>scope.insert(ident,<span style="color:#6e7681"> </span>value);<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">read_stack</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>self,<span style="color:#6e7681"> </span>ident: String)<span style="color:#6e7681"> </span>-&gt; Option<span style="color:#ff7b72;font-weight:bold">&lt;&amp;</span><span style="color:#ff7b72">i64</span><span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// Search the stack backwards.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">        </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>scope<span style="color:#6e7681"> </span><span style="color:#ff7b72">in</span><span style="color:#6e7681"> </span>self.stack.iter().rev()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>Some(x)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>scope.get(<span style="color:#ff7b72;font-weight:bold">&amp;</span>ident)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>Some(x);<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>None<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>The stack works exactly as you&rsquo;d expect. Whenever a block statement ({}) is encountered, a new scope is pushed. Within this new scope, we have access to variables initialized in lower scopes. At the end of the block statement, the scope is popped freeing all memory stored in that particular scope.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>x <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>{ <span style="color:#8b949e;font-style:italic">/* New scope pushed */</span>
</span></span><span style="display:flex;"><span>  x <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">3</span>;
</span></span><span style="display:flex;"><span>  y <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">2</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#8b949e;font-style:italic">/* Top scope popped, removing y. */</span>
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">print</span>(x); <span style="color:#8b949e;font-style:italic">/* &#34;3&#34; */</span>
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">print</span>(y); <span style="color:#8b949e;font-style:italic">/* Error: No variable named &#39;y&#39; found in stack */</span>
</span></span></code></pre></div><p>With the stack setup, we can now create our recursive function <code>Evaluator::eval</code> handling each possible node.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff7b72">pub</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">fn</span> <span style="color:#d2a8ff;font-weight:bold">eval</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#ff7b72">mut</span><span style="color:#6e7681"> </span>self,<span style="color:#6e7681"> </span>node: <span style="color:#79c0ff">&amp;</span><span style="color:#f0883e;font-weight:bold">Node</span>)<span style="color:#6e7681"> </span>-&gt; Result<span style="color:#ff7b72;font-weight:bold">&lt;</span>Option<span style="color:#ff7b72;font-weight:bold">&lt;</span><span style="color:#ff7b72">i64</span><span style="color:#ff7b72;font-weight:bold">&gt;</span>,<span style="color:#6e7681"> </span>String<span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>node<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>Node::Program<span style="color:#6e7681"> </span>{<span style="color:#6e7681"> </span>statement<span style="color:#6e7681"> </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>statement<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Some(s)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>self.eval(<span style="color:#ff7b72;font-weight:bold">&amp;</span>s),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>None<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Ok(None)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>Node::IfStatement<span style="color:#6e7681"> </span>{<span style="color:#6e7681"> </span>paren_expr,<span style="color:#6e7681"> </span>statement<span style="color:#6e7681"> </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>condition<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>self.eval(<span style="color:#ff7b72;font-weight:bold">&amp;</span>paren_expr)<span style="color:#ff7b72;font-weight:bold">?</span>.unwrap();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>condition<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>self.eval(<span style="color:#ff7b72;font-weight:bold">&amp;</span>statement)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>Ok(None)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// More nodes...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">        </span>Node::Id(x)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>self.read_stack(x.clone())<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>Some(v)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Ok(Some(v.clone())),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>None<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Err(format!(<span style="color:#a5d6ff">&#34;No variable named &#39;</span><span style="color:#a5d6ff">{}</span><span style="color:#a5d6ff">&#39; found in stack&#34;</span>,<span style="color:#6e7681"> </span>x))<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>Node::BinaryOp<span style="color:#6e7681"> </span>{<span style="color:#6e7681"> </span>op,<span style="color:#6e7681"> </span>lhs,<span style="color:#6e7681"> </span>rhs<span style="color:#6e7681"> </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">let</span><span style="color:#6e7681"> </span>r<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span>self.eval(<span style="color:#ff7b72;font-weight:bold">&amp;</span>rhs)<span style="color:#ff7b72;font-weight:bold">?</span>.unwrap();<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span>op<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>Operator::Assign<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">match</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&amp;**</span>lhs<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                        </span>Node::Id(id)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                            </span>self.write_stack(id.clone(),<span style="color:#6e7681"> </span>r);<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                            </span>Ok(Some(r))<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                        </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                        </span>_<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Err(<span style="color:#a5d6ff">&#34;Expected identifier to the left of &#39;=&#39;&#34;</span>.to_string())<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>Operator::Plus<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Ok(Some(self.eval(<span style="color:#ff7b72;font-weight:bold">&amp;</span>lhs)<span style="color:#ff7b72;font-weight:bold">?</span>.unwrap()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">+</span><span style="color:#6e7681"> </span>r)),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>Operator::Minus<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Ok(Some(self.eval(<span style="color:#ff7b72;font-weight:bold">&amp;</span>lhs)<span style="color:#ff7b72;font-weight:bold">?</span>.unwrap()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">-</span><span style="color:#6e7681"> </span>r)),<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// More operators...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#6e7681">                </span>_<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Err(format!(<span style="color:#a5d6ff">&#34;Unknown operator </span><span style="color:#a5d6ff">{:?}</span><span style="color:#a5d6ff">&#34;</span>,<span style="color:#6e7681"> </span>op))<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>},<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>_<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=&gt;</span><span style="color:#6e7681"> </span>Err(format!(<span style="color:#a5d6ff">&#34;Unsupported node &#39;</span><span style="color:#a5d6ff">{:?}</span><span style="color:#a5d6ff">&#39;&#34;</span>,<span style="color:#6e7681"> </span>node))<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>With evaluating done, there isn&rsquo;t much left to do. If we run</p>
<pre tabindex="0"><code>$ cargo run fib.tinyc
</code></pre><p>it will now parse the file, create the abstract syntax tree, then evaluate to print a single &ldquo;55&rdquo; to the terminal. I&rsquo;m sure the code can be cleaned up, optimized and overall improved. But for a beginner rust project, I am happy with the outcome. If you want to see the code in full, it is available on GitHub at <a href="https://github.com/AmberThrall/TinyC"  class="external-link" target="_blank" rel="noopener">https://github.com/AmberThrall/TinyC</a>.</p>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2025
     Amber Thrall 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
